<script>
document.addEventListener("DOMContentLoaded", () => {
  // 多重初期化ガード
  if (window.__imgModalInit) return;
  window.__imgModalInit = true;

  // モーダル生成（既存がなければ）
  let modal = document.getElementById("img-modal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "img-modal";
    modal.setAttribute("role", "dialog");
    modal.setAttribute("aria-modal", "true");
    modal.innerHTML = `
      <div class="img-modal__backdrop" data-close></div>
      <figure class="img-modal__panel">
        <img alt="">
        <figcaption class="img-modal__caption" hidden></figcaption>
        <button type="button" class="img-modal__close" aria-label="閉じる" title="閉じる">×</button>
      </figure>
    `;
    document.body.appendChild(modal);
  }

  const imgEl   = modal.querySelector("img");
  const capEl   = modal.querySelector(".img-modal__caption");
  const closeEl = modal.querySelector(".img-modal__close");

  let lastFocused = null;

  const openModal = (src, altText = "") => {
    lastFocused = document.activeElement; // ← ここで保存
    imgEl.src = src;
    imgEl.alt = altText;
    if (altText && altText.trim()) {
      capEl.textContent = altText;
      capEl.hidden = false;
    } else {
      capEl.textContent = "";
      capEl.hidden = true;
    }
    modal.classList.add("is-open");
    document.documentElement.classList.add("no-scroll");
    closeEl.focus({ preventScroll: true });
  };

  const closeModal = () => {
    modal.classList.remove("is-open");
    document.documentElement.classList.remove("no-scroll");
    if (lastFocused && typeof lastFocused.focus === "function") {
      lastFocused.focus({ preventScroll: true });
    }
  };

  const handleImageClick = (e) => {
    const img = e.target.closest(".image-group img");
    if (!img) return;
    openModal(img.currentSrc || img.src, img.getAttribute("alt") || "");
  };

  const handleModalClick = (e) => {
    // 背景クリック or ×ボタンで閉じる
    if (e.target.hasAttribute("data-close") || e.target === closeEl) {
      closeModal();
    }
  };

  const handleKeydown = (e) => {
    if (!modal.classList.contains("is-open")) return;
    if (e.key === "Escape") closeModal();
  };

  // イベント登録
  document.body.addEventListener("click", handleImageClick);
  modal.addEventListener("click", handleModalClick);
  document.addEventListener("keydown", handleKeydown);

});
</script>
